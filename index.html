<!doctype html>
<html lang="en">

<head>
	<title>SGCI Shipping Calendar</title>
  	<!--change vendor to carrier, add second thing for bill of lading, colors, late/issues, mark as complete-->
  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  	<script src = "https://unpkg.com/tooltip.js/dist/umd/tooltip.min.js"></script>
  	<link rel="stylesheet" href="css/style.css">
  	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  	<script src = "https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.1.1/pdfobject.min.js"></script>
  
  	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  
  	<link href="css/bootstrap.min.css" rel="stylesheet">
  	<link href='fullcalendar/core/main.css' rel='stylesheet' />
    <link href='fullcalendar/daygrid/main.css' rel='stylesheet' />
    <link href='fullcalendar/timegrid/main.css' rel='stylesheet' />

  	<script src='fullcalendar/core/main.js'></script>
    <script src='fullcalendar/daygrid/main.js'></script>
	<script src='fullcalendar/timegrid/main.js'></script>
    <script src='fullcalendar/interaction/main.js'></script>
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-app.js"></script>

	<!--Firestore and fire analytics-->
	<script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-firestore.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-analytics.js"></script>
  	<!--PRIMARY CALENDAR & EVENT MANAGEMENT SCRIPT--> 		  
  	<script>  	

  		var _DEBUG = false;
  		var curMinute;
  		var curHour;
  		var curDay;
  		var curMonth;
  		var curYear;
  		var calendar;

      	document.addEventListener('DOMContentLoaded', function() {
	        var calendarEl = document.getElementById('calendar');

	        calendar = new FullCalendar.Calendar(calendarEl, {
	        	weekends: false,
	        	height: 600,
	        	minTime: "07:00:00",
	        	maxTime: "22:00:00",
	        	plugins: [ 'dayGrid', 'timeGrid', 'interaction' ],
	            defaultView: 'timeGridWeek',
	          	selectable: false,
	          	header: {
	      			left: 'prev,next, today',
	     			center: 'title',
	      			right: 'timeGridDay, timeGridWeek, dayGridMonth'
	    		},
	    		//Date clicking handling 
	        	dateClick: function(info) {
	        		curDay = info.date.getDate();
	    			curMonth = info.date.getMonth() + 1;
		    		curYear = info.date.getFullYear();
		          	//display new shipment form
		    		$("#formcontainer").slideDown(0); 

		    		$("#dateAlert").html(`Selected Date: <b>${curMonth}/${curDay}/${curYear}</b>`);
		    		//flash selection colour
		    		info.dayEl.style.backgroundColor = '#c7c7c7';
		    		setTimeout(function() {info.dayEl.style.backgroundColor = 'white';}, 100);
		    		window.scrollTo({
		    			top: 2000,
		    			behavior: 'smooth',
		    		});
		    		curDay = info.date.getDate();
		    		curMonth = info.date.getMonth() + 1;
		    		curYear = info.date.getFullYear();	            
	    		}, //end dateClick
	    		eventClick: function(info) {
	    			//populate event info modal with event data
	    			var time = (info.event.allDay) ? "No window specified." : `${info.event.extendedProps.eventStartTime}-${info.event.extendedProps.eventEndTime}`;
	    			var type = (info.event.extendedProps.isOutgoing) ? "OUTGOING SHIPMENT" : "INCOMING DELIVERY"
					$("#modalVendor").html(`${info.event.title} - ${type}`);
	    			$("#modalCustomer").html(` ${info.event.extendedProps.customerName}`);
	    			$("#modalDate").html(` ${info.event.extendedProps.eventDate}`);
	    			if (!info.event.allDay) {
		    			$("#modalTime").html(` ${info.event.extendedProps.eventStartTime}-${info.event.extendedProps.eventEndTime}`);
		    		}
	    			else {
	    				$("#modalTime").html(" No time specified.");
	    			}
	    			$("#modalDestination").html(` ${info.event.extendedProps.destination}`);
	    			$("#modalComments").html(` ${info.event.extendedProps.comments}`);

	    			//PDFObject.embed(info.event.extendedProps.shipTicketURL, "#pdfContainer");
	    			PDFObject.embed('/pdf/sample-3pp.pdf', "#pdfContainer");
	    			$("#myModal").modal("show");
	            }
	        
	        });
	       	calendar.render();
	       	console.log(calendar);
	       	/*
 			* Schedule truck: collect form data, wrap into event obj, and place it in the calendar and hide the form.
 			*/
 			$("#submitTruckBtn").click(function() {
	 	  		//unwrapping data...
			 	var startTime = $("#startTime").val();
			 	var endTime = $("#endTime").val();
			 	//FIXME DIFFERENTIATE BETWEEN INVALID AND ALL DAY EVENTS
			 	console.log("here: " + startTime + ".");
			 	var allDay = (startTime === "");
			 	var startHour;
			 	var startMinute;
			 	var endHour;
			 	var endMinute;
			 	var isOutgoing = ($("#outgoingbtn").attr("class") === "btn btn-primary");
			 	var bkgColor = (isOutgoing ?  '#1a75ff' : '#EF2E2E');
			 	console.log(`Outgoing: ${isOutgoing}`);
			 	if (!allDay) { 
			 		startHour = startTime.split(":")[0];
			 		startMinute = startTime.split(":")[1];
			 		endHour = endTime.split(":")[0];
			 		endMinute = endTime.split(":")[1];
			 	}
			 	var date = $("#dateAlert").text().split(":")[1];
			 	var customerName = $("#customerBox").val();
				var vendorName = $("#vendorBox").val();
			 	var destination = $("#destinationBox").val();
			 	var comments = $("#notesArea").val();
			 	if (_DEBUG) {
				 	console.log(startTime);
				 	console.log(endTime);
				 	console.log(date);
				 	console.log(customerName);
				 	console.log(`vendorName: ${vendorName}`);
				 	console.log(destination);
			 	}

			 	//packing data into object
			 	var newEvent;
				if (!allDay) {

					newEvent = {
			              title: vendorName,
			              start: new Date (curYear,curMonth - 1, curDay, startHour, startMinute),
			              end: new Date (curYear, curMonth - 1, curDay, endHour, endMinute),
			              allDay: allDay,
			              editable: false,
			              backgroundColor: bkgColor,
			              displayEventEnd: true,
			              isOutgoing: isOutgoing,
			              customerName: customerName,
			              eventDate: date,
			              destination: destination,
			              eventStartTime: startTime,
			              eventEndTime: endTime,
			              shipTicketURL: URL.createObjectURL(document.getElementById('shipTicketFileArea').files[0]),
			              comments: comments

			              

				    };
				} else {
					newEvent = {
						title: vendorName,
						start: new Date(curYear, curMonth - 1, curDay),
						allDay: allDay,
						editable: false,
						backgroundColor: bkgColor,
						displayEventEnd: true,
						isOutgoing: isOutgoing,
						customerName: customerName,
			            eventDate: date,
			            destination: destination,
			            eventStartTime: startTime,
			            eventEndTime: endTime,
			            shipTicketURL: URL.createObjectURL(document.getElementById('shipTicketFileArea').files[0]),
			            comments: comments
						
					};
				}
			 	//insert new object into calendar as event 
			 	//TODO: change this to an event source method after we confirm the new event has been entered into the database

				db.collection("events").add({
    				allDay: allDay,
    				date: date,
    				customerName: customerName,
    				destination: destination,
    				startTime: startTime,
    				endTime: endTime,
    				isOutgoing: isOutgoing,
    				notes: comments,
    				title: vendorName,
    				nonconforming: "you betcha"
				})
				.then(function(docRef) {
    				console.log(`Document ${docRef.id} successfully written`);
				})
				.catch(function(error) {
    				console.error("Error writing document: ", error);
				});

			 	//calendar.addEvent(newEvent);
			 	//hide form
			 	$("#formcontainer").slideUp(300);
			 	//scroll to top
			 	window.scrollTo({
			 		top: 0,
			 		behavior: 'smooth'
			 	});
			 });
   		});     



      
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyBo4nl7Mdie9miskxI6zIC91fkqAjlZqn8",
    authDomain: "sgci-rds.firebaseapp.com",
    databaseURL: "https://sgci-rds.firebaseio.com",
    projectId: "sgci-rds",
    storageBucket: "sgci-rds.appspot.com",
    messagingSenderId: "184884483557",
    appId: "1:184884483557:web:6ccaf82fe8987830c3cb0c",
    measurementId: "G-WVCBC8FL46"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  var db = firebase.firestore();
  //query for events
  /*
  db.collection('events').get().then((snapshot) => {
  	snapshot.docs.forEach(doc => {
  		console.log(doc.data());

  	})
  })
  */
  /*
   * PRIMARY EVENT UPDATE LISTENER
   */
  db.collection("events").onSnapshot(snapshot => {
  	let changes = snapshot.docChanges();
  	console.log(changes);
  	changes.forEach(change => {
  		if (change.type === "added") {
  			
  			let data = change.doc.data();
  			let day = data.date.split('/')[1];
  			let month = data.date.split('/')[0] - 1;
  			let year = data.date.split('/')[2];
  			console.log(month,day,year);
  			let dateObj = new Date(year, month, day);
  			//console.log(data);
  			var newEvent;
  			if (!data.allDay) {
  					
  					let startHour = data.startTime.split(':')[0];
  					let startMinute = data.startTime.split(':')[1];
  					let endHour = data.endTime.split(':')[0];
  					let endMinute = data.endTime.split(':')[1];
  					let startDate = new Date(year, month, day, startHour, startMinute);
  					let endDate = new Date(year, month, day, endHour, endMinute);
					newEvent = {
			              title: data.title,
			              start: startDate,
			              end: endDate,
			              allDay: data.allDay,
			              editable: false,
			              backgroundColor: 'blue',
			              displayEventEnd: true,
			              isOutgoing: data.isOutgoing,
			              customerName: data.customerName,
			              eventDate: data.date,
			              destination: data.destination,
			              eventStartTime: data.startTime,
			              eventEndTime: data.endTime,
			              comments: data.notes

  					};
				} else {
					let dateObj = new Date(year, month - 2, day);
					newEvent = {
						title: data.title,
						start: dateObj,
						allDay: data.allDay,
						editable: false,
						backgroundColor: 'blue',
						displayEventEnd: true,
						isOutgoing: data.isOutgoing,
						customerName: data.customerName,
			            eventDate: data.date,
			            destination: data.destination,
			            eventStartTime: data.startTime,
			            eventEndTime: data.endTime,
			            comments: data.notes
						
					};
				} //end else
				//let calendar = document.getElementById("calendar");
				calendar.addEvent(newEvent);
				console.log(calendar.getEvents())
  			
  		} //end added type
  	});
  	//calendar.render();
  });

  //test add
  /*
  db.collection("users").add({
    username: "Gamer",
    password: "gaming1sC00l",
    name: "Spencer Douglas"
});*/

  //test print
  /*
  db.collection("users").get().then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
        console.log(`${doc.id} => ${doc.data()}`);
    });
}); */


    </script>
</head>

<body>
<!-- EVENT DATA MODAL -->
<div class="modal" tabindex="-1" role="dialog" id= "myModal">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="display-4" id = "modalVendor">Modal title</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true" id = "closeModal">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      <div class = "container" id = "modalContainer">
        <div class = "row"><h5>Date: </h5><h5 id="modalDate" style ="font-weight: normal;"></h5></div>
        <div class = "row"><h5>Arrival Window: </h5><h5 id="modalTime" style ="font-weight: normal;"></h5></div>
        <div class = "row"><h5>Customer Name: </h5><h5 id="modalCustomer" style ="font-weight: normal;"></h5></div>
        <div class = "row"><h5>Destination: </h5><h5 id="modalDestination" style ="font-weight: normal;"></h5></div>
        <div class = "row"><h5>Comments/Notes: </h5><h5 id="modalComments" style ="font-weight: normal;"></h5></div>
      </div>
      	<h4>Ship Ticket</h4>
      	<small id="pdfHelp" class="form-text text-muted>">Hover over pdf to print or download.</small>		
        <div id = "pdfContainer"  aria-describedby="pdfHelp"></div>
      
  	  </div>
      <div class="modal-footer">
      	<small id= "eventId" style="float: left;"> Event ID: not implemented</small>
      	<button type="button" class="btn btn-danger" id = "deleteShipmentBtn">Delete Shipment</button>
        <button type="button" class="btn btn-primary">Edit Info</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!--END MODAL-->
<div class ="container">
	<p id = "demo">Not working</p>
	<br>
	<h2 id = "instructions">Click a date to schedule a truck. Click an event to view/edit its information.</h2>

	<!--
	<div class="col-lg-12">
	  <div id="panel1" class="panel panel-primary">
		  <div class="panel-heading">#panel1</div>
		  <div class="panel-body"> Content! </div>
	  </div>
	</div>  
	  <div class="col-xs-3">
	  <div id="panel2" class="panel panel-primary">
	  <div class="panel-heading">
	   #panel2
	  </div>
	  <div class="panel-body"> Content?</div>
	</div>
</div>
-->
	<div id = "calendar"> </div>
	</div>
<div class = "container" id = "formcontainer">
	<div id = "dateAlert" class="alert alert-primary" role="alert">
	If you see this, tell Spencer!
	</div>
		<form>
            <div class="form-group">
			 <div class="btn-group" role="group" aria-label="Basic example">
 				 <button type="button" class="btn btn-primary" id = "outgoingbtn">Outgoing Shipment</button> 
  				 <button type="button" class="btn btn-outline-primary" id = "incomingbtn">Incoming Delivery</button>
			 </div>
			</div>
		  <!-- -->
		  <div class = "form-group">
		  	<label for="startTime">Arrival Window:</label>
			<input type="time" id="startTime" name="startTime" min= "06:30" max = "23:00" aria-describedby="timeHelpBlock">
			<input type="time" id="endTime" name="endTime"  min= "06:30" max = "23:00" aria-describedby="timeHelpBlock">
			<button type="button" class="btn btn-danger" id ="clearTimeBtn">Reset</button>
			<small id="timeHelpBlock" class="form-text text-muted">Leave blank if there is no specified time.</small>
			
		  </div>
		  <div class="form-group">
		    <label for="vendorBox">Carrier</label>
		    <input type="text" class="form-control" id="vendorBox" placeholder="Vendor Name">
		  </div>
		  <div class="form-group">
		    <label for="customerBox">Customer</label>
		    <input type="text" class="form-control" id="customerBox" placeholder="Customer Name">
		  </div>
		  <div class="form-group">
		    <label for="destinationBox">Destination</label>
		    <input type="text" class="form-control" id="destinationBox" placeholder="123 Easy St, Whitestown, IN 46075">
		  </div>
		  <!-- -->
		  <!--SHIP TICKET FILE SELECTION-->
		  <div class="form-group">
    		<label for="shipTicketFileArea">Ship Ticket</label>
    		<script>
    		var loadFile = function(event) {
					uploadedFile = URL.createObjectURL(event.target.files[0]);
					//PDFObject.embed(uploadedFile, "#pdfContainer");
					};
			</script>
    		<input type="file" class="form-control-file" id="shipTicketFileArea" accept=".pdf">

  		  </div>
  		  <!--END FILE SELECTION-->
		  
		  

  		  <!--COMMENTS TEXT AREA-->
		  <div class="form-group">
		    <label for="notesArea">Comments/Notes</label>
		    <textarea class="form-control" id="notesArea" rows="3"></textarea>
		  </div>
  		  
		  <button type="button" class="btn btn-primary" id = "submitTruckBtn">Schedule Truck</button>
		</form>
		<script>

		</script>
	</div>




<script>

</script>

</body>
<script src="js/scripts.js"></script>
</html>
