<!doctype html>
<html lang="en">
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-app.js"></script>
        <link rel="icon" type="image/ico" href="img/favicon.ico">
            <script src = "https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.1.1/pdfobject.min.js"></script>
  
  
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href='fullcalendar/core/main.css' rel='stylesheet' />
    <link href='fullcalendar/daygrid/main.css' rel='stylesheet' />
    <link href='fullcalendar/timegrid/main.css' rel='stylesheet' />
    
    <script src='fullcalendar/core/main.js'></script>
    <script src='fullcalendar/daygrid/main.js'></script>
    <script src='fullcalendar/timegrid/main.js'></script>
    <script src='fullcalendar/interaction/main.js'></script>
    <!--Firestore and fire analytics-->
    <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-analytics.js"></script>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel = "stylesheet">
    <script src = "js/auth.js" async></script>

    <!--PRIMARY CALENDAR & EVENT MANAGEMENT SCRIPT-->         
    <script>    

        var _DEBUG = false;
        var curMinute;
        var curHour;
        var curDay;
        var curMonth;
        var curYear;
        var calendar;

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            calendar = new FullCalendar.Calendar(calendarEl, {
                themeSystem: 'standard',
                height: "auto",
                weekends: false,
                nowIndicator: true,
                minTime: "06:00:00",
                maxTime: "16:30:00",
                plugins: [ 'dayGrid', 'timeGrid', 'interaction' ],
                defaultView: 'timeGridWeek',
                selectable: false,
                header: {
                    left: 'prev,next, today',
                    center: 'title',
                    right: 'timeGridDay, timeGridWeek, dayGridMonth'
                },
                //Date clicking handling 
                dateClick: function(info) {
                    curDay = info.date.getDate();
                    curMonth = info.date.getMonth() + 1;
                    curYear = info.date.getFullYear();
                    //display new shipment form
                    $("#formcontainer").slideDown(0); 

                    $("#dateAlert").html(`Selected Date: <b>${curMonth}/${curDay}/${curYear}</b>`);
                    //flash selection colour
                    let oldColor = info.dayEl.style.backgroundColor;
                    info.dayEl.style.backgroundColor = '#c7c7c7';
                    setTimeout(function() {info.dayEl.style.backgroundColor = oldColor;}, 100);
                    //window.scrollTo((document.getElementById('formcontainer').scrollTop));
                    document.getElementById('formcontainer').scrollIntoView({ behavior: "smooth", block: 'nearest'});

                    curDay = info.date.getDate();
                    curMonth = info.date.getMonth() + 1;
                    curYear = info.date.getFullYear();              
                }, //end dateClick
                eventClick: function(info) {
                    //populate event info modal with event data
                    var time = (info.event.allDay) ? "No window specified." : `${info.event.extendedProps.eventStartTime}-${info.event.extendedProps.eventEndTime}`;
                    var type = (info.event.extendedProps.isOutgoing) ? "OUTGOING SHIPMENT" : "INCOMING DELIVERY"
                    $("#modalVendor").html(`${info.event.title} - ${type}`);
                    $("#modalCustomer").html(` ${info.event.extendedProps.customerName}`);
                    $("#modalDate").html(` ${info.event.extendedProps.eventDate}`);
                    if (!info.event.allDay) {
                        $("#modalTime").html(` ${info.event.extendedProps.eventStartTime}-${info.event.extendedProps.eventEndTime}`);
                    }
                    else {
                        $("#modalTime").html(" No time specified.");
                    }
                    $("#modalDestination").html(` ${info.event.extendedProps.destination}`);
                    $("#modalComments").html(` ${info.event.extendedProps.comments}`);
                    $("#eventId").html(info.event.extendedProps.docId);

                    PDFObject.embed(info.event.extendedProps.shipTicketURL, "#shipTicketPdfContainer");
                    PDFObject.embed(info.event.extendedProps.ladingURL, "#ladingPdfContainer");
                    
                    $("#myModal").modal("show");
                }
            
            });
            calendar.render();
            


            /*
            * Schedule truck: collect form data, wrap into event obj, and place it in the calendar and hide the form.
            */
            $("#submitTruckBtn").click(async function() {
                //unwrapping data...
                var startTime = $("#startTime").val();
                var endTime = $("#endTime").val();
                //FIXME DIFFERENTIATE BETWEEN INVALID AND ALL DAY EVENTS
                var allDay = (startTime === "");
                var startHour;
                var startMinute;
                var endHour;
                var endMinute;
                var isOutgoing = ($("#outgoingbtn").attr("class") === "btn btn-primary");
                var bkgColor = (isOutgoing ?  '#1a75ff' : '#F24E1B');
                if (!allDay) { 
                    startHour = startTime.split(":")[0];
                    startMinute = startTime.split(":")[1];
                    endHour = endTime.split(":")[0];
                    endMinute = endTime.split(":")[1];
                }
                var date = $("#dateAlert").text().split(":")[1];
                var customerName = $("#customerBox").val();
                var vendorName = $("#vendorBox").val();
                var destination = $("#destinationBox").val();
                var comments = $("#notesArea").val();
                if (_DEBUG) {
                    console.log(startTime);
                    console.log(endTime);
                    console.log(date);
                    console.log(customerName);
                    console.log(`vendorName: ${vendorName}`);
                    console.log(destination);
                }
                //insert new object into calendar as event 
                //TODO: change this to an event source method after we confirm the new event has been entered into the database
                let shipTicketFile = document.getElementById('shipTicketFileArea').files[0];
                let ladingBillFile = document.getElementById('ladingBillFileArea').files[0];
                if (shipTicketFile == undefined || ladingBillFile == undefined) {
                    alert("Please upload all necessary paperwork!");
                    return;
                }
                let shipTicketUpload = await uploadTaskPromise(shipTicketFile);
                let ladingBillUpload = await uploadTaskPromise(ladingBillFile);

                let shipTicketURL = shipTicketUpload.downloadURL;
                let shipTicketRef = shipTicketUpload.ref;
                let ladingBillURL = ladingBillUpload.downloadURL;
                let ladingBillRef = ladingBillUpload.ref;

                console.log(`shipTicketURL: ${shipTicketURL}`);
                console.log(`ladingBillURL: ${ladingBillURL}`);
                console.log(`shipTicketRef: ${shipTicketRef}`);
                console.log(`ladingBillRef: ${ladingBillRef}`);
                db.collection("events").add({
                    allDay: allDay,
                    date: date,
                    customerName: customerName,
                    destination: destination,
                    isOutgoing: isOutgoing,
                    startTime: startTime,
                    endTime: endTime,
                    notes: comments,
                    title: vendorName,
                    shipTicketURL: shipTicketURL,
                    ladingURL: ladingBillURL,
                    shipTicketRef: shipTicketRef,
                    ladingBillRef: ladingBillRef
                }).then(function(docRef) {
                    console.log(`Document ${docRef.id} successfully written`);
                }).catch(function(error) {
                    console.error("Error writing document: ", error);
                });
                    
                async function uploadTaskPromise(file) {
                    return new Promise(function(resolve, reject) {
                        let fileName = uuidv4();
                        let fileRef = storageRef.child(fileName);
                        uploadTask = fileRef.put(file);
                        uploadTask.on('state_changed',
                            function(snapshot) {
                                var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                console.log('Upload is ' + progress + '% done');
                            },
                            function error(err) {
                                console.log('error', err);
                                reject();
                            },
                            function complete() {
                                uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                                    resolve({downloadURL: downloadURL, ref: fileName});
                                })
                            });
                    }); 
                }
            



                //calendar.addEvent(newEvent);
                //hide form
                $("#formcontainer").slideUp(300);
                $("#newTruckForm").hide();
                //scroll to top
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
             }); //end submit truck button handling
        }); //end DOM content loaded event listener



      
  // Your web app's Firebase configuration

  // Initialize Firebase
    var firebaseConfig = {
    apiKey: "AIzaSyBo4nl7Mdie9miskxI6zIC91fkqAjlZqn8",
    authDomain: "sgci-rds.firebaseapp.com",
    databaseURL: "https://sgci-rds.firebaseio.com",
    projectId: "sgci-rds",
    storageBucket: "sgci-rds.appspot.com",
    messagingSenderId: "184884483557",
    appId: "1:184884483557:web:6ccaf82fe8987830c3cb0c",
    measurementId: "G-WVCBC8FL46"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
   console.log(firebase.auth().currentUser);
  var db = firebase.firestore();
  var storageRef = firebase.storage().ref();
  /*
   * PRIMARY EVENT POPULATION LISTENER
   */
  db.collection("events").onSnapshot(snapshot => {
    let changes = snapshot.docChanges();
    console.log(changes);
    changes.forEach(change => {
        if (change.type === "removed") {
            //FIXME: find a better solution to this
            setTimeout(function() { location.reload(); }, 750);
        }
        else if (change.type === "added") {
            let data = change.doc.data();
            let day = data.date.split('/')[1];
            let month = data.date.split('/')[0] - 1;
            let year = data.date.split('/')[2];
            let dateObj = new Date(year, month, day);
            let bkgColor = data.isOutgoing ? '#5da4c2' : '#eb8944';
            let borderColor = !data.isOutgoing ? '#5da4c2' : '#eb8944';
            let shipTicketURL = data.shipTicketURL;
            let ladingURL = data.ladingURL;
            //TODO: 

            var newEvent;

            if (!data.allDay) {
                    let startHour = data.startTime.split(':')[0];
                    let startMinute = data.startTime.split(':')[1];
                    let endHour = data.endTime.split(':')[0];
                    let endMinute = data.endTime.split(':')[1];
                    let startDate = new Date(year, month, day, startHour, startMinute);
                    let endDate = new Date(year, month, day, endHour, endMinute);
                    
                    
                    newEvent = {
                          title: data.title,
                          start: startDate,
                          end: endDate,
                          allDay: data.allDay,
                          editable: false,
                          backgroundColor: bkgColor,
                          borderColor: borderColor,
                          displayEventEnd: true,
                          isOutgoing: data.isOutgoing,
                          customerName: data.customerName,
                          eventDate: data.date,
                          destination: data.destination,
                          eventStartTime: data.startTime,
                          eventEndTime: data.endTime,
                          comments: data.notes,
                          docId: change.doc.id,
                          ladingURL: ladingURL,
                          shipTicketURL: shipTicketURL

                    }; //newEvent
                } else {
                    let dateObj = new Date(year, month, day);
                    newEvent = {
                        title: data.title,
                        start: dateObj,
                        allDay: data.allDay,
                        editable: false,
                        backgroundColor: bkgColor,
                        borderColor: borderColor,
                        displayEventEnd: true,
                        isOutgoing: data.isOutgoing,
                        customerName: data.customerName,
                        eventDate: data.date,
                        destination: data.destination,
                        eventStartTime: data.startTime,
                        eventEndTime: data.endTime,
                        comments: data.notes,
                        docId: change.doc.id,
                        ladingURL: ladingURL,
                        shipTicketURL: shipTicketURL
                        
                    }; //newEvent
                } //end else
                calendar.addEvent(newEvent);
            
        } //end added type
        
        //TODO: HANDLE DELETE AND UPDATE
    });
  }); //END FIRESTORE EVENT CHANGE LISTENER
    </script>

    </head>

    <body>
        <header><img src = "img/bluelogo.svg" id = "blueLogo"> <btn id = "signOutBtn" class = "btn btn-secondary">Sign Out</btn></header>
<div id = "loginApplet" >
        <div class = "container centered-container">
            <p class = "sg-font-hdr">Stephen Gould Indianapolis Shipping and Receiving</p>

            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">Log In</a>
                    <a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">Create New Account</a>
                </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
                    <form>
                            <h3 class = "landing-hdr">Login</h3>

                            <div class="form-group">
                                <label for ="email">Email Address</label>
                                <input id = "loginEmail" type="email" class="form-control" placeholder="name@stephengould.com" autocomplete="email" />
                            </div>

                            <div class="form-group">
                                <label for = "password">Password</label>
                                <input id = "loginPass" type="password" class="form-control" placeholder = "Password" autocomplete="password" />
                            </div>
                            <button type="button" class="btn btn-primary login-btn" id = "signInBtn">Sign In</button>
                            <p class="forgot-password text-center">
                                 <a href="#" id = "forgotPassLink">Forgot Password?</a>
                            </p>
                    </form>
                </div>
                        <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">
                            <form>
                                <h3 class = "landing-hdr">New User</h3>

                                <div class="form-group">
                                    <label for ="newUserEmail">Email Address</label>
                                    <input id = "newUserEmail" type="email" class="form-control" placeholder="example@stephengould.com" />
                                </div>
                                <div class="form-group">
                                    <label for ="newUserName">Name</label>
                                    <input id = "newUserName" type="text" class="form-control" placeholder="First and Last Name" />
                                </div>
                                <div class="form-group">
                                    <label for = "newUserPass">Password</label>
                                    <input id = "newUserPass" type="password" class="form-control" placeholder="Must be at least 6 characters" />
                                </div>
                                <button type="button" class="btn btn-primary login-btn" id = "createAccountBtn">Create Account</button>
                                
                            </form>
                        </div>
            </div>
            
        </div>
    </div>
        

<div class ="container" id = "calendarApplet">
    <h3 id = "instructions" style="text-align: center;">Click a date to schedule a truck. Click an event to view/edit its information.</h2>


    <div id = "calendar"> </div>

<div class = "container" id = "formcontainer">
    <div id = "dateAlert" class="alert alert-primary" role="alert">
    If you see this, tell Spencer!
    </div>
        <form id = "newTruckForm">
            <div class="form-group">
             <div class="btn-group" role="group" aria-label="Basic example">
                 <button type="button" class="btn btn-primary" id = "outgoingbtn">Outgoing Shipment</button> 
                 <button type="button" class="btn btn-outline-primary" id = "incomingbtn">Incoming Delivery</button>
             </div>
            </div>
          <!-- -->
          <div class = "form-group">
            <label for="startTime">Arrival Window:</label>
            <input type="time" id="startTime" name="startTime" min= "06:30" max = "23:00" aria-describedby="timeHelpBlock">
            <input type="time" id="endTime" name="endTime"  min= "06:30" max = "23:00" aria-describedby="timeHelpBlock">
            <button type="button" class="btn btn-danger" id ="clearTimeBtn">Reset</button>
            <small id="timeHelpBlock" class="form-text text-muted">Leave blank if there is no specified time.</small>
            
          </div>
          <div class="form-group">
            <label for="vendorBox">Carrier</label>
            <input type="text" class="form-control" id="vendorBox" placeholder="Carrier/Vendor Name">
          </div>
          <div class="form-group">
            <label for="customerBox">Customer</label>
            <input type="text" class="form-control" id="customerBox" placeholder="Customer Name">
          </div>
          <div class="form-group">
            <label for="destinationBox">Destination</label>
            <input type="text" class="form-control" id="destinationBox" placeholder="123 Easy St, Whitestown, IN 46075">
          </div>
          <!-- -->
          <!--SHIP TICKET FILE SELECTION-->
          <div class="form-group">
            <label for="shipTicketFileArea">Ship Ticket (must be .pdf)</label>
            
            <input type="file" class="form-control-file" id="shipTicketFileArea" accept=".pdf">

          </div>
          <!--END FILE SELECTION-->
          <!--BILL OF LADING FILE SELECTION-->
          <div class="form-group">
            <label for="ladingBillFileArea">Bill of Lading (must be .pdf)</label>
            
            <input type="file" class="form-control-file" id="ladingBillFileArea" accept=".pdf">

          </div>
          <!--END FILE SELECTION-->
          
          

          <!--COMMENTS TEXT AREA-->
          <div class="form-group">
            <label for="notesArea">Comments/Notes</label>
            <textarea class="form-control" id="notesArea" rows="3"></textarea>
          </div>
          
          <button type="button" class="btn btn-primary" id = "submitTruckBtn">Schedule Truck</button>
        </form>
    </div>
</div>


        <footer>

          <text>Developed by Spencer Douglas - <u><a href="mailto:dougla55@purdue.edu" style = "color: #082a40; font-size: 10px;">dougla55@purdue.edu</a></u></text>
          <p id = "version">Version</p>
        </footer>
    </body>
            <!-- EVENT DATA MODAL -->
<div class="modal" tabindex="-1" role="dialog" id= "myModal">

    <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-header">
        <h3 id = "modalVendor">Modal title</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" id = "closeModal">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div class = "container" id = "modalContainer">
            <div class = "row"><b>Date: </b><b id="modalDate" style ="font-weight: normal;"></b></div>
            <div class = "row"><b>Arrival Window: </b><b id="modalTime" style ="font-weight: normal;"></b></div>
            <div class = "row"><b>Customer Name: </b><b id="modalCustomer" style ="font-weight: normal;"></b></div>
            <div class = "row"><b>Destination: </b><b id="modalDestination" style ="font-weight: normal;"></b></div>
            <div class = "row"><b>Comments/Notes: </b><b id="modalComments" style ="font-weight: normal;"></b></div>
          </div>
            <h4>Shipment Paperwork</h4>
            <small id="pdfHelp" class="form-text text-muted>">Hover over pdf to print or download. Click arrows to switch files.</small>        
            
            <div class ="row" style="width: 100%; margin: 0 auto; height: 100%;">
                <a href="#pdfCarousel" role="button" data-slide="prev" style = "width: 10%; background-color: black;">
                    <div class = "container">
                        <span class="carousel-control-prev-icon" aria-hidden="true" style = "top: 50%; bottom: 50%;"></span>
                        <span class="sr-only">Previous</span>
                    </div>
                </a>
                <div id="pdfCarousel" class="carousel slide" data-interval = "false">
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <div class = "container">
                                <div id = "shipTicketPdfContainer"  aria-describedby="pdfHelp"></div>
                            </div>
                                                
                        </div>
                        <div class="carousel-item">
                            <div class = "container">
                            <div id = "ladingPdfContainer"  aria-describedby="pdfHelp"></div>
                        </div>
                        </div>
            
                    </div>
                
                </div>
            
                <a href="#pdfCarousel" role="button" data-slide="next" style = "width: 10%; background-color: black;">
                    <div class = "container">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                    </div>
                </a>
                
            </div>
      </div>
      <div class="modal-footer">
        <small id="eventId"> Event ID Error</small>
        <button type="button" class="btn btn-danger" id = "deleteShipmentBtn">Delete Shipment</button>
        <script>
            //delete file on click
            $("#deleteShipmentBtn").click(function() {
                if (confirm("Are you sure you wish to delete the event? This cannot be undone.")) {
                    let shipFile;
                    let billFile; 
                    let shipRef;
                    let billRef;
                    let docRef = db.collection("events").doc($("#eventId").html());
                    docRef.get().then(function(doc) {
                        shipFile = doc.data().shipTicketRef;
                        billFile = doc.data().ladingBillRef;
                        console.log(shipFile, billFile);
                        shipRef = storageRef.child(shipFile);
                        billRef = storageRef.child(billFile);
                        docRef.delete().then(function() {
                        console.log("Document deleted.");
                        shipRef.delete().then(function() {
                          // File deleted successfully
                          console.log("ship deleted");
                        }).catch(function(error) {
                            console.log("ship failed: " + error);
                        });

                        billRef.delete().then(function() {
                            // File deleted successfully
                            console.log("bill deleted");
                        }).catch(function(error) {
                              // Uh-oh, an error occurred!
                        });
                    //hide the modal
                    $("#myModal").modal("hide");

                }).catch(function(error) {
                    console.error(`Error removing document (${error})`);
                });
                    });
                    
                
            } 
          });

        </script>
        <button type="button" class="btn btn-primary">Edit Info</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!--END MODAL-->
</html>